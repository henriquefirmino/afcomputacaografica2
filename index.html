<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Babylon.js sample code</title>

        <!-- Babylon.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://preview.babylonjs.com/ammo.js"></script>
        <script src="https://preview.babylonjs.com/cannon.js"></script>
        <script src="https://preview.babylonjs.com/Oimo.js"></script>
        <script src="https://preview.babylonjs.com/earcut.min.js"></script>
        <script src="https://preview.babylonjs.com/babylon.js"></script>
        <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
        </style>
    </head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        var canvas = document.getElementById("renderCanvas");

        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function() { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true,  disableWebGL2Support: false}); };

        var createScene = function () {
            var scene = new BABYLON.Scene(engine);

            //Skybox
            var skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size:1000.0}, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("textures/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skybox.material = skyboxMaterial;
            
            var camera = new BABYLON.ArcRotateCamera("Camera", Math.PI / 8, Math.PI / 2.5, 50, BABYLON.Vector3.Zero(), scene);
            
            camera.attachControl(canvas, true);
            
            var light = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0, 1, 0), scene);

            var gravityVector = new BABYLON.Vector3(0, -10, 0);
            var physicsPlugin = new BABYLON.CannonJSPlugin();
            scene.enablePhysics(gravityVector, physicsPlugin);

            //physics
            let cannon = true;
            let forceFactor = cannon ? 1 : 1500; 
            scene.enablePhysics(undefined, (!cannon ? new BABYLON.OimoJSPlugin(100) : new BABYLON.CannonJSPlugin(true, 100)));
            scene.enablePhysics(new BABYLON.Vector3(0, -1, 0), new BABYLON.AmmoJSPlugin(true));

            //base giratorio horizontal
            let axel1 = BABYLON.MeshBuilder.CreateCylinder("axel1", {diameter: 1, height:2}, scene);
            axel1.material = new BABYLON.StandardMaterial("", scene);
            axel1.material.diffuseColor = new BABYLON.Color3(0, 1, 0);
            axel1.rotation.x = Math.PI / 2;
            axel1.position.z = 5;
        
            let local1 = localAxes(8);
            local1.parent = axel1;
        
        	let wheel1 = BABYLON.MeshBuilder.CreateBox("base1", {lenght: 70, height: 0.2, width: 10, depth: 38}, scene);
            wheel1.material = new BABYLON.StandardMaterial("wheelMat", scene);
            wheel1.material.diffuseTexture = new BABYLON.Texture("textures/1.jpg", scene);
            wheel1.rotation.x = Math.PI/2;
            wheel1.position.z = 5;
        
            // base
            wheel1.physicsImpostor = new BABYLON.PhysicsImpostor(wheel1, BABYLON.PhysicsImpostor.BoxImpostor, {mass: 10, friction:0});
        
            // mesh central
            axel1.physicsImpostor = new BABYLON.PhysicsImpostor(axel1, BABYLON.PhysicsImpostor.CylinderImpostor, {mass: 0, friction: 0});
        
            var joint1 = new BABYLON.HingeJoint({  
                // mainPivot: new BABYLON.Vector3(0, 0, 0),
                // connectedPivot: new BABYLON.Vector3(0, 0, 0),
                // mainAxis: new BABYLON.Vector3(0, 1, 0),
                // connectedAxis: new BABYLON.Vector3(0, 1, 0),
                // nativeParams: {
                // }
            });
            axel1.physicsImpostor.addJoint(wheel1.physicsImpostor, joint1);   

            axel1.isVisible = false;
        
            // come√ßa a rodar
            joint1.setMotor(-1, 1);
        
            // eixos
            function localAxes(size) {
                var pilot_local_axisX = BABYLON.Mesh.CreateLines("pilot_local_axisX", [], scene);
        
                pilot_local_axisY = BABYLON.Mesh.CreateLines("pilot_local_axisY", [], scene);
        
                var pilot_local_axisZ = BABYLON.Mesh.CreateLines("pilot_local_axisZ", [], scene);
        
                var local_origin = BABYLON.MeshBuilder.CreateBox("local_origin", { size: 1 }, scene);
                local_origin.isVisible = false;
        
                return local_origin;
        
            }

            //plataformas
            var box = BABYLON.MeshBuilder.CreateBox("box1", {lenght: 10, width: 15, depth: 5, height: 0.1}, scene);
            box.position.x = 0;
            box.position.y = 25;
            box.rotation.y = 1.56;
            box.position.z = -55;
            box.rotation.z = 0.2;

            var plat1 = BABYLON.MeshBuilder.CreateBox("plat1", {lenght: 10, width: 15, depth: 5, height: 0.1}, scene);

            var plat2 = BABYLON.MeshBuilder.CreateBox("plat2", {lenght: 10, width: 15, depth: 5, height: 0.1}, scene);

            var plat3 = BABYLON.MeshBuilder.CreateBox("plat3", {lenght: 10, width: 15, depth: 5, height: 0.1}, scene);

            var plat4 = BABYLON.MeshBuilder.CreateBox("plat4", {lenght: 10, width: 15, depth: 5, height: 0.1}, scene);

            var plat5 = BABYLON.MeshBuilder.CreateBox("plat5", {lenght: 10, width: 5, depth: 0.1, height: 20}, scene);

            var plat6 = BABYLON.MeshBuilder.CreateBox("plat6", {lenght: 10, width: 5, depth: 0.1, height: 30}, scene);

            var plat7 = BABYLON.MeshBuilder.CreateBox("plat7", {lenght: 10, width: 15, depth: 5, height: 0.1}, scene);

            var plat8 = BABYLON.MeshBuilder.CreateBox("plat8", {lenght: 15, width: 15, depth: 5, height: 0.1}, scene);

            //posicao plataformas
            plat1.position.y = -5;
            plat1.position.z = -30;
            plat1.rotation.y = 1.56;
            plat1.rotation.z = -0.2;

            plat2.position.y = -11;
            plat2.position.z = -34;
            plat2.rotation.y = 1.56;
            plat2.rotation.z = 0.2;

            plat3.position.y = -17;
            plat3.position.z = -30;
            plat3.rotation.y = 1.56;
            plat3.rotation.z = -0.2;

            plat4.position.y = -23;
            plat4.position.z = -34;
            plat4.rotation.y = 1.56;
            plat4.rotation.z = 0.2;

            plat5.position.y = -10;
            plat5.position.z = -22;
            plat5.isVisible = false;

            plat6.position.y = -16;
            plat6.position.z = -42;
            plat6.isVisible = false;

            plat7.position.y = -16;
            plat7.position.z = 60;
            plat7.rotation.y = 1.56;
            plat7.rotation.z = 0.5;

            plat8.position.y = -16;
            plat8.position.z = 77;
            plat8.rotation.y = 1.56;
            plat8.rotation.z = -0.5;

            let holder = BABYLON.MeshBuilder.CreateSphere("holder", {diameter: 2, segments: 4}, scene);
            let wheel = BABYLON.MeshBuilder.CreateSphere("base", {diameterY: 10, diameterZ: 1, diameterX: 10}, scene);
            holder.position.x = 0;
            holder.position.y = 10;
            holder.position.z = -40;
            holder.rotation.y = 7.85;
            
            let box1 = BABYLON.MeshBuilder.CreateBox("1", {width: 4, height:1, depth:3}, scene);
            box1.parent = wheel;
            box1.position.x = 5;
            
            let box2 = box1.clone("2");
            box2.position.x = -5;
            
            let box3 = box1.clone("3");
            box3.position.x = 0;
            box3.position.y = 5;
            box3.rotation.z = Math.PI / 2;
            
            box4 = box3.clone("4");
            box4.position.y = -5;

            // var gravityVector = new BABYLON.Vector3(0, -10, 0);
            // var physicsPlugin = new BABYLON.CannonJSPlugin();
            // scene.enablePhysics(gravityVector, physicsPlugin);

            //bola dominos
            var ball = new BABYLON.MeshBuilder.CreateSphere("bola", {diameter: 3});
            ball.position.x = 0;
            ball.position.y = 2;
            ball.position.z = 50;

            ball.physicsImpostor = new BABYLON.PhysicsImpostor(ball, BABYLON.PhysicsImpostor.SphereImpostor, {mass: 1});
            

            var ticker = 0;

            let spheres = [];

            scene.registerBeforeRender(function() {
                if(ticker++ % 30) return;

                let s = BABYLON.MeshBuilder.CreateSphere("s", {diameter: 2});
                s.position.y = 100;
                s.position.z = -60;
                s.position.x = 0;

                s.physicsImpostor = new BABYLON.PhysicsImpostor(s, BABYLON.PhysicsImpostor.SphereImpostor, {mass: 5});
                spheres.push(s);
            });

            //domino
            let box5 = BABYLON.MeshBuilder.CreateBox("5", {width: 0.5, height:5, depth:2}, scene);
            box5.material = new BABYLON.StandardMaterial("box5Mat", scene);
            box5.material.diffuseTexture = new BABYLON.Texture("textures/domino1.png", scene);
            box5.position.x = 0;
            box5.position.y = 3;
            box5.position.z = 24;
            box5.rotation.y = 1.5;
            
            let box6 = BABYLON.MeshBuilder.CreateBox("6", {width: 0.5, height:5, depth:2}, scene);
            box6.material = new BABYLON.StandardMaterial("box6Mat", scene);
            box6.material.diffuseTexture = new BABYLON.Texture("textures/domino2.png", scene);
            box6.position.x = 0;
            box6.position.y = 3;
            box6.position.z = 29;
            box6.rotation.y = 1.5;
            
            let box7 = BABYLON.MeshBuilder.CreateBox("7", {width: 0.5, height:5, depth:2}, scene);
            box7.material = new BABYLON.StandardMaterial("box7Mat", scene);
            box7.material.diffuseTexture = new BABYLON.Texture("textures/domino3.png", scene);
            box7.position.x = 0;
            box7.position.y = 3;
            box7.position.z = 34;
            box7.rotation.y = 1.5;

            let box8 = BABYLON.MeshBuilder.CreateBox("8", {width: 0.5, height:5, depth:2}, scene);
            box8.material = new BABYLON.StandardMaterial("box8Mat", scene);
            box8.material.diffuseTexture = new BABYLON.Texture("textures/domino4.png", scene);
            box8.position.x = 0;
            box8.position.y = 3;
            box8.position.z = 39;
            box8.rotation.y = 1.5;

            let box9 = BABYLON.MeshBuilder.CreateBox("9", {width: 0.5, height:5, depth:2}, scene);
            box9.material = new BABYLON.StandardMaterial("box9Mat", scene);
            box9.material.diffuseTexture = new BABYLON.Texture("textures/domino5.png", scene);
            box9.position.x = 0;
            box9.position.y = 3;
            box9.position.z = 44;
            box9.rotation.y = 1.5;

            let chao = BABYLON.MeshBuilder.CreateBox("c", {width: 25, height:0.5, depth:40}, scene);
            chao.position.x = 0;
            chao.position.y = 0;
            chao.position.z = 38;
            chao.rotation.y = 3.15;
            //chao.isVisible = false;
            //fim

            //ribbon
            var path0 = [];
            for (let a = 0; a < Math.PI; a += Math.PI / 8) {
                path0.push(new BABYLON.Vector3(-4, 4 * Math.cos(a), -8 + 4 * Math.sin(a)));
            }

            var path1 = [];
            for (let a = 0; a < Math.PI; a += Math.PI / 8) {
                path1.push(new BABYLON.Vector3(0, 4 * Math.cos(a), 2 + 4 * Math.sin(a)));
            }

            var path2 = [];
            for (let a = 0; a < Math.PI; a += Math.PI / 8) {
                path2.push(new BABYLON.Vector3(3, 4 * Math.cos(a), -8 + 4 * Math.sin(a)));
            }
            
            //Array of paths to construct ribbon
            var myPaths1 = [path0, path1, path2];
            
            var ribbon = BABYLON.MeshBuilder.CreateRibbon("ribbon", {pathArray: myPaths1, closeArray: true, sideOrientation: BABYLON.Mesh.DOUBLESIDE});
            ribbon.checkCollisions = true;

            ribbon.position.y = -33;
            ribbon.position.z = -20;
            ribbon.rotation.x = -4.5;
    
            
            [box, box1, box2, box3, box4, chao].forEach((mesh) => {
                mesh.physicsImpostor = new BABYLON.PhysicsImpostor(mesh, BABYLON.PhysicsImpostor.BoxImpostor, {mass: 0});
            });
            //fisica domino
            [box5, box6, box7, box8, box9].forEach((mesh) => {
                mesh.physicsImpostor = new BABYLON.PhysicsImpostor(mesh, BABYLON.PhysicsImpostor.BoxImpostor, {mass: 5});  
            });

            //fisica plataformas
            [plat1, plat2, plat3, plat4, plat5, plat6, /*plat7, plat8*/].forEach((mesh) => {
                mesh.physicsImpostor = new BABYLON.PhysicsImpostor(mesh, BABYLON.PhysicsImpostor.BoxImpostor, {mass: 0});  
            });
                
            wheel.physicsImpostor = new BABYLON.PhysicsImpostor(wheel, BABYLON.PhysicsImpostor.SphereImpostor, {mass: 10});
            holder.physicsImpostor = new BABYLON.PhysicsImpostor(holder, BABYLON.PhysicsImpostor.SphereImpostor, {mass: 0});

            //fisica ribbon
            //ribbon.physicsImpostor = new BABYLON.PhysicsImpostor(ribbon, BABYLON.PhysicsImpostor.HeightmapImpostor, {mass: 0});
            
            var joint1 = new BABYLON.HingeJoint({  
                mainPivot: new BABYLON.Vector3(0, 0, 0),
                connectedPivot: new BABYLON.Vector3(0, 0, 0),
                mainAxis: new BABYLON.Vector3(0, 0, -1),
                connectedAxis: new BABYLON.Vector3(0, 0, -1),
                nativeParams: {
                }
            });
            holder.physicsImpostor.addJoint(wheel.physicsImpostor, joint1);  
            
            joint1.setMotor(3 * forceFactor, 20 * forceFactor);

            return scene;
        }
                window.initFunction = async function() {               
                    var asyncEngineCreation = async function() {
                        try {
                        return createDefaultEngine();
                        } catch(e) {
                        console.log("the available createEngine function failed. Creating the default engine instead");
                        return createDefaultEngine();
                        }
                    }

                    window.engine = await asyncEngineCreation();
        if (!engine) throw 'engine should not be null.';
        window.scene = createScene();};
        initFunction().then(() => {sceneToRender = scene        
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    sceneToRender.render();
                }
            });
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
</body>
</html>
